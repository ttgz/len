<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Sản phẩm Len & Phụ kiện</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
        }

        .product-card {
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
        }

        .image-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }

        .variant-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
        }

        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .upload-area:hover {
            border-color: #0d6efd;
        }

        .upload-area.dragover {
            border-color: #0d6efd;
            background-color: #f8f9ff;
        }

        .price-text {
            color: #198754;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .table img {
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="d-flex align-items-center mb-4">
                    <i class="fas fa-box text-primary fs-1 me-3"></i>
                    <h1 class="mb-0">Quản lý Sản phẩm Len & Phụ kiện</h1>
                </div>

                <!-- Search and Filters -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" id="searchInput" class="form-control"
                                placeholder="Tìm kiếm sản phẩm, thương hiệu...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select id="categoryFilter" class="form-select">
                            <option value="Tất cả">Tất cả danh mục</option>
                            <option value="Len">Len</option>
                            <option value="Phụ kiện">Phụ kiện</option>
                        </select>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-primary" id="addProductBtn">
                        <i class="fas fa-plus me-2"></i>Thêm sản phẩm
                    </button>
                    <button class="btn btn-success" id="importBtn">
                        <i class="fas fa-upload me-2"></i>Import Excel
                    </button>
                    <button class="btn btn-warning" id="exportBtn">
                        <i class="fas fa-download me-2"></i>Export Excel
                    </button>
                </div>
            </div>
        </div>

        <!-- Products Grid -->
        <div id="productsGrid" class="row">
            <!-- Products will be rendered here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <i class="fas fa-box fs-1 mb-3"></i>
            <h4>Không tìm thấy sản phẩm nào</h4>
            <p class="text-muted">Hãy thử thay đổi từ khóa tìm kiếm hoặc thêm sản phẩm mới</p>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">Thêm sản phẩm mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label">Tên sản phẩm *</label>
                                <input type="text" id="productName" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Giá (VNĐ) *</label>
                                <input type="number" id="productPrice" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Chuẩn hóa tìm kiếm</label>
                                <textarea class="form-control" id="seo" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Hình ảnh sản phẩm</label>
                            <div class="upload-area" id="uploadArea">
                                <i class="fas fa-cloud-upload-alt fs-2 text-muted mb-2"></i>
                                <p class="mb-2">Kéo thả hoặc click để chọn ảnh</p>
                                <input type="file" id="productImage" class="d-none" accept="image/*">
                            </div>
                            <div id="imagePreview" class="mt-3" style="display: none;">
                                <img id="previewImg" class="image-preview" alt="Preview">
                                <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="removeImage">
                                    <i class="fas fa-trash"></i> Xóa ảnh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" id="saveProductBtn">
                        <i class="fas fa-save me-2"></i>Lưu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Edit Modal -->
    <div class="modal fade" id="productEditModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chỉnh sửa sản phẩm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label">Tên sản phẩm *</label>
                                <input type="text" id="productNameEdit" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Giá (VNĐ) *</label>
                                <input type="number" id="productPriceEdit" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Chuẩn hóa tìm kiếm</label>
                                <textarea class="form-control" id="seoEdit" rows="3"></textarea>
                            </div>
                            <input type="hidden" id="productId">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Hình ảnh sản phẩm</label>
                            <div class="upload-area" id="uploadAreaEdit">
                                <i class="fas fa-cloud-upload-alt fs-2 text-muted mb-2"></i>
                                <p class="mb-2">Kéo thả hoặc click để chọn ảnh</p>
                                <input type="file" id="productImageEdit" class="d-none" accept="image/*">
                            </div>
                            <div id="imagePreviewEdit" class="mt-3" style="display: none;">
                                <img id="previewImgEdit" class="image-preview" alt="Preview">
                                <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="removeImageEdit">
                                    <i class="fas fa-trash"></i> Xóa ảnh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" id="saveEditProductBtn">
                        <i class="fas fa-save me-2"></i>Lưu thay đổi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Variant Modal -->
    <div class="modal fade" id="variantModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="variantModalTitle">Quản lý biến thể</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Danh sách biến thể</h6>
                        <button class="btn btn-primary btn-sm" id="addVariantBtn">
                            <i class="fas fa-plus me-2"></i>Thêm biến thể
                        </button>
                    </div>
                    <div id="variantsTableContainer">
                        <!-- Variants table will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Variant Form Modal -->
    <div class="modal fade" id="variantFormModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="variantFormTitle">Thêm biến thể mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label">Tên biến thể *</label>
                                <input type="text" id="variantName" class="form-control"
                                    placeholder="VD: Màu đỏ - Size L">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Giá (VNĐ) *</label>
                                <input type="number" id="variantPrice" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Hình ảnh biến thể</label>
                            <div class="upload-area" id="uploadAreaVariant">
                                <i class="fas fa-image fs-2 text-muted mb-2"></i>
                                <p class="mb-2">Chọn ảnh biến thể</p>
                                <input type="file" id="variantImage" class="d-none" accept="image/*">
                            </div>
                            <div id="imagePreviewVariant" class="mt-3" style="display: none;">
                                <img id="previewImgVariant" class="image-preview" alt="Preview">
                                <button type="button" class="btn btn-sm btn-outline-danger mt-2"
                                    id="removeImageVariant">
                                    <i class="fas fa-trash"></i> Xóa ảnh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" id="saveVariantBtn">
                        <i class="fas fa-save me-2"></i>Lưu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" class="d-none">

    <script>
        $(document).ready(function () {
            let currentProduct = null;
            let currentVariant = null;
            let editingProductId = null;
            let editingVariantId = null;

            // Image upload handlers
            function setupImageUpload(uploadAreaId, fileInputId, previewId, previewImgId, removeId) {
                const uploadArea = $(`#${uploadAreaId}`);
                const fileInput = $(`#${fileInputId}`);
                const preview = $(`#${previewId}`);
                const previewImg = $(`#${previewImgId}`);
                const removeBtn = $(`#${removeId}`);

                uploadArea.click(() => fileInput.click());

                fileInput.change(function (e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            previewImg.attr('src', e.target.result);
                            preview.show();
                            uploadArea.hide();
                        };
                        reader.readAsDataURL(file);
                    }
                });

                removeBtn.click(function () {
                    fileInput.val('');
                    preview.hide();
                    uploadArea.show();
                });

                // Drag and drop
                uploadArea.on('dragover', function (e) {
                    e.preventDefault();
                    $(this).addClass('dragover');
                });

                uploadArea.on('dragleave', function (e) {
                    e.preventDefault();
                    $(this).removeClass('dragover');
                });

                uploadArea.on('drop', function (e) {
                    e.preventDefault();
                    $(this).removeClass('dragover');

                    const files = e.originalEvent.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        if (file.type.startsWith('image/')) {
                            fileInput[0].files = files;
                            fileInput.trigger('change');
                        }
                    }
                });
            }

            // Setup image uploads
            setupImageUpload('uploadArea', 'productImage', 'imagePreview', 'previewImg', 'removeImage');
            setupImageUpload('uploadAreaEdit', 'productImageEdit', 'imagePreviewEdit', 'previewImgEdit', 'removeImageEdit');
            setupImageUpload('uploadAreaVariant', 'variantImage', 'imagePreviewVariant', 'previewImgVariant', 'removeImageVariant');

            // Render functions
            function renderProducts(products) {
                const grid = $('#productsGrid');
                const emptyState = $('#emptyState');

                if (!products || products.length === 0) {
                    grid.hide();
                    emptyState.show();
                    return;
                }

                grid.show();
                emptyState.hide();
                grid.html('');

                products.forEach(product => {
                    const imageUrl = product.image ? `/uploads/${product.image}` : 'https://via.placeholder.com/300x200?text=No+Image';

                    const productCard = `
                        <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
                            <div class="card product-card h-100">
                                <img src="${product.image}" class="card-img-top product-image" alt="${product.name}">
                                <div class="card-body">
                                    <h5 class="card-title">${product.name}</h5>
                                    <p class="card-text price-text fs-5">${product.price.toLocaleString('vi-VN')}đ</p>
                                    <div class="d-flex justify-content-between">
                                        <button class="btn btn-outline-primary btn-sm" onclick="editProduct(${product.id})">
                                            <i class="fas fa-edit me-1"></i>Sửa
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteProduct(${product.id})">
                                            <i class="fas fa-trash me-1"></i>Xóa
                                        </button>
                                    </div>
                                    <button class="btn btn-info w-100 mt-2" onclick="manageVariants(${product.id}, '${product.name}')">
                                        <i class="fas fa-list me-2"></i>Quản lý biến thể
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    grid.append(productCard);
                });
            }

            function renderVariantsTable(productId) {
                $.ajax({
                    url: '/products/' + productId,
                    success: function (data) {
                        variants(data.variants);
                    }
                });
            }

            function variants(variants) {
                const container = $('#variantsTableContainer');

                if (variants.length === 0) {
                    container.html(`
                        <div class="text-center py-5">
                            <i class="fas fa-box-open fs-1 text-muted mb-3"></i>
                            <h5>Chưa có biến thể nào</h5>
                            <p class="text-muted">Hãy thêm biến thể đầu tiên!</p>
                        </div>
                    `);
                    return;
                }

                let tableHtml = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Hình ảnh</th>
                                    <th>Tên biến thể</th>
                                    <th>Giá</th>
                                    <th width="120">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                variants.forEach(variant => {
                    const imageUrl = variant.image ? `/uploads/${variant.image}` : 'https://via.placeholder.com/60x60?text=No+Image';
                    tableHtml += `
                        <tr>
                            <td>
                                <img src="${imageUrl}" class="variant-image" alt="${variant.name}">
                            </td>
                            <td>${variant.name}</td>
                            <td class="price-text">${variant.price.toLocaleString('vi-VN')}đ</td>
                            <td>
                                <button class="btn btn-outline-primary btn-sm me-1" onclick="editVariant(${variant.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteVariant(${variant.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                tableHtml += `
                            </tbody>
                        </table>
                    </div>
                `;

                container.html(tableHtml);
            }

            // Product functions
            window.editProduct = function (id) {
                $.ajax({
                    url: '/products/' + id,
                    success: function (data) {
                        const product = data.product;
                        $('#productNameEdit').val(product.name);
                        $('#productPriceEdit').val(product.price);
                        $('#seoEdit').val(product.search);
                        $('#productId').val(product.id);

                        // Show existing image if available
                        if (product.image) {
                            $('#previewImgEdit').attr('src', `/uploads/${product.image}`);
                            $('#imagePreviewEdit').show();
                            $('#uploadAreaEdit').hide();
                        }

                        $('#productEditModal').modal('show');
                    }
                });
            };

            window.deleteProduct = function (id) {
                if (confirm('Bạn có chắc chắn muốn xóa sản phẩm này?')) {
                    $.ajax({
                        url: 'admin/products/' + id,
                        method: 'delete',
                        success: function () {
                            alert('Đã xóa vĩnh viễn sản phẩm thành công');
                            reRender();
                        }
                    })

                }
            };

            window.manageVariants = function (id, name) {
                currentProduct = { id: id };
                $('#variantModalTitle').text(`Quản lý biến thể - ${name}`);
                renderVariantsTable(id);
                $('#variantModal').modal('show');
            };

            // Variant functions
            window.editVariant = function (id) {
                editingVariantId = id;
                $('#variantFormTitle').text('Chỉnh sửa biến thể');

                // Load variant data here
                // For demo, just show the modal
                $('#variantFormModal').modal('show');
            };

            window.deleteVariant = function (id) {
                if (confirm('Bạn có chắc chắn muốn xóa biến thể này?')) {
                    // Delete logic here
                    renderVariantsTable(currentProduct.id);
                }
            };

            // Event handlers
            $('#searchInput').on('input', function () {
                const q = $(this).val().trim();
                $.ajax({
                    url: '/search',
                    data: { q },
                    success: function (data) {
                        renderProducts(data);
                    }
                });
            });

            $('#addProductBtn').click(function () {
                editingProductId = null;
                $('#productModal').modal('show');
                // Reset form
                $('#productName').val('');
                $('#productPrice').val('');
                $('#seo').val('');
                $('#productImage').val('');
                $('#imagePreview').hide();
                $('#uploadArea').show();
            });

            $('#saveProductBtn').click(function () {
                const name = $('#productName').val().trim();
                const price = parseInt($('#productPrice').val()) || 0;
                const seo = $('#seo').val();
                const image = $('#productImage')[0].files[0];

                if (!name || price <= 0) {
                    alert('Vui lòng điền đầy đủ thông tin sản phẩm!');
                    return;
                }

                const formData = new FormData();
                formData.append('name', name);
                formData.append('price', price);
                formData.append('search', seo);
                if (image) formData.append('image', image);

                $.ajax({
                    url: '/admin/products',
                    method: "POST",
                    contentType: false,
                    processData: false,
                    data: formData,
                    success: function () {
                        alert('Thêm thành công');
                        $('#productModal').modal('hide');
                        reRender();
                    }
                });
            });

            $('#saveEditProductBtn').click(function () {
                const name = $('#productNameEdit').val().trim();
                const price = parseInt($('#productPriceEdit').val()) || 0;
                const seo = $('#seoEdit').val();
                const image = $('#productImageEdit')[0].files[0];
                const id = $('#productId').val();

                if (!name || price <= 0) {
                    alert('Vui lòng điền đầy đủ thông tin sản phẩm!');
                    return;
                }

                const formData = new FormData();
                formData.append('id', id);
                formData.append('name', name);
                formData.append('price', price);
                formData.append('search', seo);
                if (image) formData.append('image', image);

                $.ajax({
                    url: '/admin/products/' + id,
                    method: "PUT",
                    contentType: false,
                    processData: false,
                    data: formData,
                    success: function () {
                        alert('Sửa thành công');
                        $('#productEditModal').modal('hide');
                        reRender();
                    }
                });
            });

            $('#addVariantBtn').click(function () {
                editingVariantId = null;
                $('#variantFormTitle').text('Thêm biến thể mới');
                $('#variantName').val('');
                $('#variantPrice').val('');
                $('#variantImage').val('');
                $('#imagePreviewVariant').hide();
                $('#uploadAreaVariant').show();
                $('#variantFormModal').modal('show');
            });

            $('#saveVariantBtn').click(function () {
                const name = $('#variantName').val().trim();
                const price = parseInt($('#variantPrice').val()) || 0;
                const image = $('#variantImage')[0].files[0];

                if (!name || price <= 0) {
                    alert('Vui lòng điền đầy đủ thông tin biến thể!');
                    return;
                }

                // Save variant logic here
                alert('Lưu biến thể thành công!');
                $('#variantFormModal').modal('hide');
                renderVariantsTable(currentProduct.id);
            });

            // Import/Export handlers
            $('#importBtn').click(function () {
                $('#fileInput').click();
            });

            $('#fileInput').change(function (e) {
                const file = e.target.files[0];
                if (file) {
                    const formData = new FormData();
                    formData.append('file', file);

                    $.ajax({
                        url: '/import-excel',
                        method: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function () {
                            alert('Import thành công');
                            reRender();
                        },
                        error: function () {
                            alert('Import thất bại');
                        }
                    });
                }
            });

            $('#exportBtn').click(function () {
                window.location.href = '/export/download-excel';
            });

            function reRender() {
                $.ajax({
                    url: '/products',
                    success: function (data) {
                        renderProducts(data);
                    }
                });
            }
            reRender();
        });
    </script>
</body>

</html>